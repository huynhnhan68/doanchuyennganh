document.getElementById('checkout').onclick = async () => {
  if (!cartRows.length) return;

  const checkoutBtn = document.getElementById('checkout');
  const originalText = checkoutBtn.innerHTML;
  checkoutBtn.innerHTML = '<span class="loading-spinner me-2"></span> Äang táº¡o thanh toÃ¡n...';
  checkoutBtn.disabled = true;

  // nhÃ³m theo store_id
  const grouped = cartRows.reduce((m, x) => {
    const sid = prodMap.get(x.product_id)?.store_id;
    (m[sid]=m[sid]||[]).push(x);
    return m;
  }, {});

  // Táº¡o 1 order DUY NHáº¤T cho VNPay (tá»•ng táº¥t cáº£ stores)
  let total = 0;
  cartRows.forEach(ci => {
    const p = prodMap.get(ci.product_id);
    if (!p) return;
    total += Number(p.price) * Number(ci.quantity);
  });

  const discount = Math.round(total * (couponPct/100));
  const payTotal = total - discount;

  // 1) táº¡o Ä‘Æ¡n trong supabase
  const ins = await supabase.from("orders").insert([{
    buyer_id: me.user_id,
    store_id: null,        // multiple store
    total_price: payTotal,
    payment_method: "VNPay",
    order_status: "pending",
    created_at: new Date().toISOString()
  }]).select().single();

  if (ins.error) {
    alert("Lá»—i táº¡o Ä‘Æ¡n: " + ins.error.message);
    checkoutBtn.innerHTML = originalText;
    checkoutBtn.disabled = false;
    return;
  }

  const orderId = ins.data.order_id;

  // 2) táº¡o chi tiáº¿t Ä‘Æ¡n
  const details = cartRows.map(ci => {
    const p = prodMap.get(ci.product_id) || {};
    return {
      order_id: orderId,
      product_id: ci.product_id,
      quantity: ci.quantity,
      price_each: p.price
    };
  });
  await supabase.from("order_details").insert(details);

  // 3) gá»i API Vercel Ä‘á»ƒ táº¡o URL VNPay
  const apiURL = "https://doanchuyennganh-v2py.vercel.app/api/vnpay/create_payment";

  const r = await fetch(apiURL, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({
      amount: payTotal,
      orderId: orderId
    })
  }).then(r => r.json());

  if (!r.paymentUrl) {
    alert("Lá»—i táº¡o URL thanh toÃ¡n");
    checkoutBtn.innerHTML = originalText;
    checkoutBtn.disabled = false;
    return;
  }

  // 4) clear cart
  await supabase.from("cart_items").delete().eq("user_id", me.user_id);

  // ðŸ‘‰ Redirect sang VNPay
  location.href = r.paymentUrl;
};
