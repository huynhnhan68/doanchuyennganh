<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MiniStore | Seller Dashboard (Ops++)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>
    :root{--primary:#4361ee;--primary-light:#4895ef;--dark:#1e1e2d;--radius:12px;--shadow:0 4px 20px rgba(0,0,0,.08)}
    body{background:#f5f7fb;font-family:'Segoe UI',sans-serif}
    .navbar{background:linear-gradient(135deg,var(--dark),#2d3748)}
    .navbar-brand{color:#4cc9f0!important;font-weight:700}
    .card{border:none;border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:1.25rem}
    .card-header{background:#fff;font-weight:600}
    .table thead{background:linear-gradient(90deg,#4361ee,#4895ef);color:#fff}
    .product-img{width:50px;height:50px;object-fit:cover;border-radius:8px;border:1px solid #eaeaea}
    .loading-spinner{width:2rem;height:2rem;border:3px solid rgba(0,0,0,.15);border-top-color:#4361ee;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .filter-group .form-control,.filter-group .form-select{max-width:200px}
    .filter-group .w-260{max-width:260px}
    .inline-edit{min-width:70px}
    .avatar{width:28px;height:28px;border-radius:50%;object-fit:cover;margin-right:6px;border:1px solid #eee}
    .linkify{color:#0d6efd;cursor:pointer;text-decoration:underline}
    .modal-header.bg-gradient{background:linear-gradient(90deg,#4361ee,#4895ef);color:#fff}
    .product-cover{width:120px;height:120px;border-radius:12px;object-fit:cover;border:1px solid #eee}
    .cover-lg{width:160px;height:160px}
    .badge-overdue{background:#ffe8e8;color:#c1121f;border:1px solid #ffc9c9}
    .print-label{font-size:12px;border:1px dashed #999;padding:8px;border-radius:8px;max-width:300px}
    .star{color:#ffb703; cursor:pointer}
    /* Toast container */
    #toastArea{position:fixed; top:12px; right:12px; z-index:1080}
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark px-4">
  <a class="navbar-brand" href="index.html"><i class="fa-solid fa-store me-2"></i>E-Shop</a>
  <div class="collapse navbar-collapse">
    <ul class="navbar-nav ms-auto">
      <li class="nav-item"><a class="nav-link" href="index.html"><i class="fa fa-home me-1"></i>Trang ch·ªß</a></li>
      <li class="nav-item"><a class="nav-link text-info" id="sellerName"></a></li>
      <li class="nav-item"><a class="nav-link" href="#" onclick="logout()"><i class="fa fa-sign-out-alt me-1"></i>ƒêƒÉng xu·∫•t</a></li>
    </ul>
  </div>
</nav>

<div id="toastArea"></div>

<div class="container my-4">
  <h2 class="mb-3"><i class="fa-solid fa-gauge me-2"></i>Qu·∫£n l√Ω c·ª≠a h√†ng</h2>

  <!-- T·ªîNG QUAN -->
  <div class="row" id="summary">
    <div class="col-md-3 mb-3"><div class="card"><div class="card-body text-center">
      <div class="text-muted">T·ªïng s·∫£n ph·∫©m</div><div class="h3 mb-0" id="count-products">0</div></div></div></div>
    <div class="col-md-3 mb-3"><div class="card"><div class="card-body text-center">
      <div class="text-muted">T·ªïng ƒë∆°n</div><div class="h3 mb-0" id="count-orders">0</div></div></div></div>
    <div class="col-md-3 mb-3"><div class="card"><div class="card-body text-center">
      <div class="text-muted">Doanh thu (‚Ç´)</div><div class="h3 mb-0" id="total-revenue">0</div></div></div></div>
    <div class="col-md-3 mb-3"><div class="card"><div class="card-body text-center">
      <div class="text-muted">T·ªâ l·ªá giao th√†nh c√¥ng</div><div class="h3 mb-0" id="deliver-rate">0%</div></div></div></div>
  </div>

  <!-- BI·ªÇU ƒê·ªí -->
  <div class="row">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fa fa-chart-column me-2"></i>Doanh thu theo th√°ng</span>
          <div class="btn-group btn-group-sm">
            <button id="btn6m" class="btn btn-outline-primary active">6 th√°ng</button>
            <button id="btn12m" class="btn btn-outline-primary">12 th√°ng</button>
          </div>
        </div>
        <div class="card-body"><canvas id="revenueChart" height="110"></canvas></div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card">
        <div class="card-header"><i class="fa fa-chart-pie me-2"></i>Ph·ªÖu tr·∫°ng th√°i ƒë∆°n</div>
        <div class="card-body"><canvas id="statusChart" height="240"></canvas></div>
      </div>
    </div>
  </div>

  <!-- TOP KH√ÅCH & CAPITAL INVENTORY -->
  <div class="row">
    <div class="col-lg-6">
      <div class="card">
        <div class="card-header"><i class="fa fa-users me-2"></i>Top kh√°ch mua nhi·ªÅu</div>
        <div class="card-body" id="top-buyers"><div class="text-muted">ƒêang t√≠nh...</div></div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fa fa-warehouse me-2"></i>Capital in Inventory</span>
          <button id="btnLowStockQuick" class="btn btn-sm btn-outline-warning">S·∫Øp h·∫øt h√†ng</button>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-sm mb-0">
              <thead><tr><th>S·∫£n ph·∫©m</th><th class="text-end">Gi√°</th><th class="text-end">T·ªìn</th><th class="text-end">Gi√° tr·ªã</th></tr></thead>
              <tbody id="capitalTable"><tr><td colspan="4" class="text-center py-3 text-muted">ƒêang t·∫£i...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- S·∫¢N PH·∫®M -->
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span><i class="fa fa-list me-2"></i>S·∫£n ph·∫©m c·ªßa b·∫°n</span>
      <div class="d-flex gap-2">
        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#productModal"><i class="fa fa-plus me-1"></i>Th√™m</button>
        <button class="btn btn-outline-secondary btn-sm" id="btnBulkActive"><i class="fa fa-eye me-1"></i>Hi·ªÉn th·ªã</button>
        <button class="btn btn-outline-secondary btn-sm" id="btnBulkInactive"><i class="fa fa-eye-slash me-1"></i>·∫®n</button>
        <button class="btn btn-outline-success btn-sm" id="btnImport"><i class="fa fa-file-import me-1"></i>Import CSV</button>
        <input id="importFile" type="file" accept=".csv" class="d-none">
      </div>
    </div>

    <!-- B·ªò L·ªåC + SAVED FILTERS -->
    <div class="p-3 border-bottom filter-group d-flex flex-wrap gap-2 align-items-center">
      <input id="kw" class="form-control w-260" placeholder="T√¨m t√™n s·∫£n ph·∫©m...">
      <select id="fcate" class="form-select"><option value="">T·∫•t c·∫£ danh m·ª•c</option></select>
      <select id="fstatus" class="form-select">
        <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
        <option value="active">ƒêang b√°n</option>
        <option value="inactive">Ng·ª´ng b√°n</option>
      </select>
      <input id="pmin" type="number" class="form-control" placeholder="Gi√° t·ª´">
      <input id="pmax" type="number" class="form-control" placeholder="Gi√° ƒë·∫øn">
      <input id="stockMax" type="number" class="form-control" placeholder="T·ªìn kho ‚â§ X">
      <button id="btnFilter" class="btn btn-primary"><i class="fa fa-filter me-1"></i>L·ªçc</button>
      <div class="ms-auto d-flex gap-2">
        <select id="savedFilters" class="form-select"><option value="">B·ªô l·ªçc ƒë√£ l∆∞u</option></select>
        <button id="btnSaveFilter" class="btn btn-outline-primary btn-sm"><i class="fa fa-bookmark me-1"></i>L∆∞u b·ªô l·ªçc</button>
      </div>
    </div>

    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0 align-middle">
          <thead>
            <tr>
              <th style="width:36px"><input type="checkbox" id="chkAll"></th>
              <th>·∫¢nh</th><th>T√™n</th><th>Danh m·ª•c</th><th class="text-end">Gi√°</th><th class="text-end">T·ªìn</th><th>TT</th><th>Thao t√°c</th>
            </tr>
          </thead>
          <tbody id="productTable">
            <tr><td colspan="8" class="text-center py-4"><div class="loading-spinner"></div> ƒêang t·∫£i...</td></tr>
          </tbody>
        </table>
      </div>
      <div class="p-3 d-flex justify-content-between align-items-center">
        <div><small id="pagingInfo" class="text-muted"></small></div>
        <div class="btn-group btn-group-sm">
          <button id="prevPage" class="btn btn-outline-secondary">¬´ Tr∆∞·ªõc</button>
          <button id="nextPage" class="btn btn-outline-secondary">Sau ¬ª</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ƒê∆†N H√ÄNG -->
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span><i class="fa fa-clipboard-list me-2"></i>ƒê∆°n h√†ng g·∫ßn ƒë√¢y</span>
      <div class="d-flex gap-2">
        <button id="btnOverdue" class="btn btn-outline-danger btn-sm">Qu√° h·∫°n (SLA)</button>
      </div>
    </div>
    <div class="p-3 border-bottom d-flex flex-wrap gap-2">
      <input id="oid" class="form-control" placeholder="M√£ ƒë∆°n #">
      <select id="ostatus" class="form-select">
        <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
        <option value="pending">ƒêang ch·ªù</option>
        <option value="confirmed">ƒê√£ x√°c nh·∫≠n</option>
        <option value="shipping">ƒêang giao</option>
        <option value="delivered">ƒê√£ giao</option>
        <option value="cancelled">ƒê√£ h·ªßy</option>
      </select>
      <input id="dateFrom" type="date" class="form-control">
      <input id="dateTo" type="date" class="form-control">
      <input id="amin" type="number" class="form-control" placeholder="T·ªïng ti·ªÅn ‚â•">
      <input id="amax" type="number" class="form-control" placeholder="T·ªïng ti·ªÅn ‚â§">
      <button id="btnOrderFilter" class="btn btn-primary"><i class="fa fa-filter me-1"></i>L·ªçc</button>
      <select id="savedOrderFilters" class="form-select ms-auto"><option value="">B·ªô l·ªçc ƒë∆°n ƒë√£ l∆∞u</option></select>
      <button id="btnSaveOrderFilter" class="btn btn-outline-primary btn-sm"><i class="fa fa-bookmark me-1"></i>L∆∞u b·ªô l·ªçc</button>
      <button id="btnExportOrders" class="btn btn-outline-primary btn-sm"><i class="fa fa-file-export me-1"></i>Xu·∫•t CSV</button>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead><tr><th>M√£ ƒë∆°n</th><th>Kh√°ch h√†ng</th><th class="text-end">T·ªïng ti·ªÅn</th><th>Tr·∫°ng th√°i</th><th>Ng√†y t·∫°o</th><th></th></tr></thead>
          <tbody id="orderTable">
            <tr><td colspan="6" class="text-center py-4"><div class="loading-spinner"></div> ƒêang t·∫£i...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: PRODUCT CRUD + VARIANTS + DISCOUNT -->
<div class="modal fade" id="productModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-gradient"><h5 class="modal-title"><i class="fa fa-box me-2"></i><span id="pmTitle">Th√™m s·∫£n ph·∫©m</span></h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <ul class="nav nav-tabs" id="productTabs" role="tablist">
          <li class="nav-item" role="presentation"><button class="nav-link active" id="tab-basic" data-bs-toggle="tab" data-bs-target="#pane-basic" type="button" role="tab">Th√¥ng tin</button></li>
          <li class="nav-item" role="presentation"><button class="nav-link" id="tab-variants" data-bs-toggle="tab" data-bs-target="#pane-variants" type="button" role="tab">Bi·∫øn th·ªÉ</button></li>
          <li class="nav-item" role="presentation"><button class="nav-link" id="tab-pricing" data-bs-toggle="tab" data-bs-target="#pane-pricing" type="button" role="tab">Gi√° nhanh</button></li>
        </ul>
        <div class="tab-content pt-3">
          <div class="tab-pane fade show active" id="pane-basic">
            <form id="productForm">
              <input type="hidden" id="editId">
              <div class="row g-3">
                <div class="col-md-8">
                  <div class="mb-3"><label class="form-label">T√™n</label><input id="pname" class="form-control" required></div>
                  <div class="mb-3"><label class="form-label">Danh m·ª•c</label><select id="pcate" class="form-select" required></select></div>
                  <div class="row">
                    <div class="col-md-6 mb-3"><label class="form-label">Gi√° (‚Ç´)</label><input id="pprice" type="number" min="0" class="form-control" required></div>
                    <div class="col-md-6 mb-3"><label class="form-label">T·ªìn kho</label><input id="pstock" type="number" min="0" class="form-control" value="0"></div>
                  </div>
                  <div class="mb-3"><label class="form-label">M√¥ t·∫£</label><textarea id="pdesc" rows="3" class="form-control"></textarea></div>
                </div>
                <div class="col-md-4">
                  <label class="form-label">·∫¢nh</label>
                  <input id="pimg" type="file" accept="image/*" class="form-control">
                  <img id="imgPreview" class="mt-2 rounded border d-none" style="max-width:100%">
                </div>
              </div>
              <button class="btn btn-primary w-100 mt-2"><i class="fa fa-save me-1"></i>L∆∞u</button>
            </form>
          </div>
          <div class="tab-pane fade" id="pane-variants">
            <div id="variantArea" class="small text-muted">ƒêang t·∫£i...</div>
            <div class="input-group input-group-sm mt-2">
              <input id="vName" class="form-control" placeholder="T√™n bi·∫øn th·ªÉ (VD: ƒê·ªè 128GB)">
              <input id="vPrice" type="number" class="form-control" placeholder="Gi√°">
              <input id="vStock" type="number" class="form-control" placeholder="T·ªìn">
              <input id="vSku" class="form-control" placeholder="SKU">
              <button id="btnAddVariant" class="btn btn-outline-primary">Th√™m</button>
            </div>
          </div>
          <div class="tab-pane fade" id="pane-pricing">
            <div class="d-flex align-items-center gap-2">
              <input id="discountPercent" type="number" class="form-control" placeholder="% gi·∫£m t·∫°m th·ªùi (0-90)" min="0" max="90">
              <button id="btnApplyDiscount" class="btn btn-outline-primary btn-sm">√Åp d·ª•ng</button>
              <button id="btnClearDiscount" class="btn btn-outline-secondary btn-sm">X√≥a</button>
            </div>
            <div class="form-text mt-2">L∆∞u local theo t·ª´ng s·∫£n ph·∫©m, ch·ªâ ·∫£nh h∆∞·ªüng hi·ªÉn th·ªã gi√° ngo√†i danh s√°ch/chi ti·∫øt (kh√¥ng ghi DB).</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: ORDER DETAIL + NOTE + RMA + SHIPPING LABEL -->
<div class="modal fade" id="orderModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-gradient"><h5 class="modal-title"><i class="fa fa-receipt me-2"></i>ƒê∆°n <span id="omId"></span></h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div id="orderDetail" class="print-area"></div>
        <div class="row g-2 align-items-center mt-2">
          <div class="col-auto"><label class="col-form-label">Tr·∫°ng th√°i</label></div>
          <div class="col-auto">
            <select id="oStatus" class="form-select">
              <option value="pending">ƒêang ch·ªù</option><option value="confirmed">ƒê√£ x√°c nh·∫≠n</option>
              <option value="shipping">ƒêang giao</option><option value="delivered">ƒê√£ giao</option><option value="cancelled">ƒê√£ h·ªßy</option>
            </select>
          </div>
          <div class="col"><input id="cancelReason" class="form-control d-none" placeholder="L√Ω do h·ªßy (t√πy ch·ªçn)"></div>
          <div class="col-12 col-md-6"><textarea id="sellerNote" class="form-control" rows="2" placeholder="Ghi ch√∫ n·ªôi b·ªô (ch·ªâ Seller th·∫•y)"></textarea></div>
          <div class="col-auto ms-auto d-flex gap-2">
            <button id="btnCreateReturn" class="btn btn-outline-danger"><i class="fa fa-rotate-left me-1"></i>T·∫°o y√™u c·∫ßu ho√†n</button>
            <button id="btnPrintLabel" class="btn btn-outline-secondary"><i class="fa fa-ticket me-1"></i>In tem</button>
            <button id="btnSaveOrder" class="btn btn-primary"><i class="fa fa-save me-1"></i>C·∫≠p nh·∫≠t</button>
          </div>
        </div>
        <div id="labelArea" class="print-label mt-3 d-none"></div>
      </div>
    </div>
  </div>
</div>

<!-- IMPORT PREVIEW MODAL -->
<div class="modal fade" id="importModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-gradient"><h5 class="modal-title"><i class="fa fa-file-import me-2"></i>Nh·∫≠p s·∫£n ph·∫©m t·ª´ CSV</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-sm">
            <thead><tr><th>#</th><th>T√™n</th><th>Danh m·ª•c</th><th>Gi√°</th><th>T·ªìn</th><th>·∫¢nh</th><th>M√¥ t·∫£</th></tr></thead>
            <tbody id="importPreview"></tbody>
          </table>
        </div>
        <button id="btnConfirmImport" class="btn btn-primary"><i class="fa fa-check me-1"></i>Nh·∫≠p</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ===== Supabase =====
const SUPABASE_URL='https://qpnqsvueowqtqnzqdyqh.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFwbnFzdnVlb3dxdHFuenFkeXFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5ODg1NDMsImV4cCI6MjA3NTU2NDU0M30.dtNEnYlLLa9mTP9Oi6uvS7PkQ2IoH6SMhXemPa0uSfs';
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

// ===== Auth =====
const user=JSON.parse(localStorage.getItem('currentUser'));
if(!user||user.role_id!==2){ alert('B·∫°n kh√¥ng c√≥ quy·ªÅn!'); location.href='login.html'; }
document.getElementById('sellerName').innerHTML=`<i class="fa fa-user me-1"></i>${user.username}`;

// ===== State =====
let store=null,categories=[],products=[],productsView=[],page=1,pageSize=10,orders=[],currentOrder=null;
let buyerMap=new Map(); let hasVariantsTable=false; let hasReturnsTable=false; let hasSellerNoteColumn=false;
let importRows=[];

// ===== Toast =====
function showToast(msg,type='info'){ const id='t'+Date.now(); const bg = type==='success'?'bg-success text-white': type==='danger'?'bg-danger text-white': type==='warning'?'bg-warning':'bg-light'; const el=document.createElement('div'); el.id=id; el.className=`toast align-items-center ${bg} border-0 mb-2`; el.setAttribute('role','alert'); el.innerHTML=`<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button></div>`; document.getElementById('toastArea').appendChild(el); const t=new bootstrap.Toast(el,{delay:3000}); t.show(); setTimeout(()=>el.remove(),3500); }

// ===== Utils =====
const VND=v=>Number(v||0).toLocaleString('vi-VN')+' ‚Ç´';
function storagePathFromUrl(url){ const i=url.indexOf('/object/public/'); if(i<0) return null; return url.substring(i+16); }
async function upload(bucket,file,prefix=''){ const name=`${prefix}${Date.now()}_${file.name}`; const {error}=await supabase.storage.from(bucket).upload(name,file); if(error) throw error; const {data}=supabase.storage.from(bucket).getPublicUrl(name); return data.publicUrl; }
async function removeByUrl(url){ const path=storagePathFromUrl(url); if(!path) return; const [bucket,...rest]=path.split('/'); await supabase.storage.from(bucket).remove([rest.join('/')]); }
function setCache(key,data,minutes){ localStorage.setItem(key, JSON.stringify({data, exp: Date.now()+minutes*60000})); }
function getCache(key){ const raw=localStorage.getItem(key); if(!raw) return null; try{ const obj=JSON.parse(raw); if(Date.now()>obj.exp){ localStorage.removeItem(key); return null; } return obj.data; }catch{ return null; } }
const discountKey=id=>`disc_${id}`;
const featuredKey='featuredIds';
const noteKey=id=>`seller_note_${id}`;
const savedFiltersKey='seller_saved_filters';
const savedOrderFiltersKey='seller_saved_order_filters';

// ===== Init =====
init();
async function init(){
  // store
  const rs=await supabase.from('stores').select('*').eq('user_id',user.user_id).maybeSingle();
  store=rs.data||null; if(!store){ showToast('Kh√¥ng t√¨m th·∫•y c·ª≠a h√†ng','danger'); return; }

  // categories with cache 24h
  const cache=getCache('categories_cache');
  if(cache){ categories=cache; } else{ const rc=await supabase.from('categories').select('*').order('category_name'); categories=rc.data||[]; setCache('categories_cache', categories, 60*24); }
  document.getElementById('pcate').innerHTML=categories.map(c=>`<option value="${c.category_id}">${c.category_name}</option>`).join('');
  document.getElementById('fcate').innerHTML='<option value="">T·∫•t c·∫£ danh m·ª•c</option>'+categories.map(c=>`<option value="${c.category_id}">${c.category_name}</option>`).join('');

  // detect optional schema
  hasVariantsTable = await tableExists('product_variants');
  hasReturnsTable  = await tableExists('returns');
  hasSellerNoteColumn = await columnExists('orders','seller_note');

  // products & orders
  await refreshProducts();
  await refreshOrders();
  drawRevenueChart(6); drawStatusChart();

  // top buyers & capital
  buildTopBuyers();
  buildCapitalTable();

  // controls
  document.getElementById('btn6m').onclick=()=>{ drawRevenueChart(6); toggleRange(true); };
  document.getElementById('btn12m').onclick=()=>{ drawRevenueChart(12); toggleRange(false); };
  document.getElementById('btnFilter').onclick=applyProductFilter;
  document.getElementById('chkAll').onclick=e=>document.querySelectorAll('.rowChk').forEach(ch=>ch.checked=e.target.checked);
  document.getElementById('prevPage').onclick=()=>{ if(page>1){page--; renderProducts();}};
  document.getElementById('nextPage').onclick=()=>{ const max=Math.ceil(productsView.length/pageSize)||1; if(page<max){page++; renderProducts();}};
  document.getElementById('btnBulkActive').onclick=()=>bulkUpdateStatus('active');
  document.getElementById('btnBulkInactive').onclick=()=>bulkUpdateStatus('inactive');
  document.getElementById('pimg').addEventListener('change', e=>{
    const f=e.target.files?.[0]; const img=document.getElementById('imgPreview');
    if(!f){ img.classList.add('d-none'); return; } img.src=URL.createObjectURL(f); img.classList.remove('d-none');
  });
  document.getElementById('productForm').addEventListener('submit', saveProduct);
  document.getElementById('btnApplyDiscount').onclick=applyDiscount;
  document.getElementById('btnClearDiscount').onclick=clearDiscount;
  document.getElementById('btnLowStockQuick').onclick=()=>{ document.getElementById('stockMax').value=5; applyProductFilter(); };

  document.getElementById('btnOrderFilter').onclick=applyOrderFilter;
  document.getElementById('btnExportOrders').onclick=exportOrdersCSV;
  document.getElementById('btnOverdue').onclick=()=>{ filterOverdue(); };

  // Saved filters
  document.getElementById('btnSaveFilter').onclick=saveCurrentFilter;
  document.getElementById('savedFilters').onchange=loadSavedFilter;
  document.getElementById('btnSaveOrderFilter').onclick=saveCurrentOrderFilter;
  document.getElementById('savedOrderFilters').onchange=loadSavedOrderFilter;
  hydrateSavedFilters();
  hydrateSavedOrderFilters();

  // Import CSV
  document.getElementById('btnImport').onclick=()=>document.getElementById('importFile').click();
  document.getElementById('importFile').addEventListener('change', handleImportFile);
  document.getElementById('btnConfirmImport').onclick=confirmImport;

  // realtime orders
  supabase.channel('orders_seller_channel').on('postgres_changes',{event:'INSERT',schema:'public',table:'orders'},payload=>{
    const o=payload.new; if(o.store_id===store.store_id){ showToast(`üîî ƒê∆°n m·ªõi #${o.order_id} - ${VND(o.total_price)}`,'success'); refreshOrders(); drawStatusChart(); buildTopBuyers(); }
  }).subscribe();
}

function toggleRange(is6){ document.getElementById('btn6m').classList.toggle('active',is6); document.getElementById('btn12m').classList.toggle('active',!is6); }

async function tableExists(table){ try{ const r=await supabase.from(table).select('*').limit(1); return !(r.error && r.error.message?.includes('does not exist')); }catch{ return false; } }
async function columnExists(table, col){ try{ const r=await supabase.from(table).select(col).limit(1); return !(r.error && r.error.message?.includes('column')); }catch{ return false; } }

// ===== Products =====
async function refreshProducts(){
  const r=await supabase.from('products').select('*').eq('store_id',store.store_id).order('created_at',{ascending:false});
  products=r.data||[];
  document.getElementById('count-products').innerText=products.length;
  applyProductFilter();
  buildCapitalTable();
}

function displayPrice(p){
  const d=Number(localStorage.getItem(discountKey(p.product_id))||0);
  const price=Number(p.price)||0;
  if(!d||d<=0) return VND(price);
  const discounted= Math.round(price*(1-d/100));
  return `<span class="text-decoration-line-through text-muted me-1">${VND(price)}</span><span class="fw-semibold text-success">${VND(discounted)}</span> <span class="badge bg-warning text-dark">-${d}%</span>`;
}

function applyProductFilter(){
  const kw=(document.getElementById('kw').value||'').toLowerCase().trim();
  const cate=document.getElementById('fcate').value;
  const stt=document.getElementById('fstatus').value;
  const pmin=Number(document.getElementById('pmin').value||0);
  const pmaxRaw=document.getElementById('pmax').value;
  const pmax=pmaxRaw===''?Number.POSITIVE_INFINITY:Number(pmaxRaw);
  const sMaxRaw=document.getElementById('stockMax').value;
  const sMax=sMaxRaw===''?Number.POSITIVE_INFINITY:Number(sMaxRaw);
  productsView=products.filter(p=>{
    const byKw=!kw||(p.product_name||'').toLowerCase().includes(kw);
    const byCate=!cate||String(p.category_id)===String(cate);
    const byStt=!stt||p.status===stt;
    const byPrice=Number(p.price)>=pmin && Number(p.price)<=pmax;
    const byStock=Number(p.stock)<=sMax;
    return byKw && byCate && byStt && byPrice && byStock;
  });
  page=1; renderProducts();
}

function renderProducts(){
  const tbody=document.getElementById('productTable');
  if(!productsView.length){ tbody.innerHTML=`<tr><td colspan="8" class="text-center py-4 text-muted">Kh√¥ng c√≥ s·∫£n ph·∫©m</td></tr>`; document.getElementById('pagingInfo').innerText=''; return; }
  const start=(page-1)*pageSize, end=Math.min(start+pageSize, productsView.length);
  const slice=productsView.slice(start,end);
  const cateName=id => (categories.find(c=>c.category_id===id)||{}).category_name || '-';
  const featured=JSON.parse(localStorage.getItem(featuredKey)||'[]');
  tbody.innerHTML = slice.map(p=>`
    <tr>
      <td><input type="checkbox" class="rowChk" value="${p.product_id}"></td>
      <td><img src="${p.image_url||'https://via.placeholder.com/50x50?text=No+Img'}" class="product-img" onerror="this.src='https://via.placeholder.com/50x50?text=No+Img'"></td>
      <td class="fw-semibold">${p.product_name} <i class="fa fa-star star ${featured.includes(p.product_id)?'':'opacity-25'}" title="Ghim n·ªïi b·∫≠t" onclick="toggleFeatured(${p.product_id})"></i></td>
      <td>${cateName(p.category_id)}</td>
      <td class="text-end">${displayPrice(p)}</td>
      <td class="text-end">${p.stock}</td>
      <td><span class="badge ${p.status==='active'?'bg-success':'bg-secondary'}">${p.status==='active'?'ƒêang b√°n':'Ng·ª´ng b√°n'}</span></td>
      <td class="text-nowrap">
        <button class="btn btn-sm btn-outline-primary me-1" onclick='editProduct(${JSON.stringify(p)})'><i class="fa fa-pen"></i></button>
        <button class="btn btn-sm btn-outline-secondary me-1" onclick='duplicateProduct(${p.product_id})'><i class="fa fa-copy"></i></button>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct(${p.product_id}, '${p.image_url||''}')"><i class="fa fa-trash"></i></button>
      </td>
    </tr>`).join('');
  document.getElementById('pagingInfo').innerText=`Hi·ªÉn th·ªã ${start+1}-${end} / ${productsView.length}`;
}

function toggleFeatured(id){
  const arr=JSON.parse(localStorage.getItem(featuredKey)||'[]');
  const idx=arr.indexOf(id); if(idx>=0) arr.splice(idx,1); else arr.push(id);
  localStorage.setItem(featuredKey, JSON.stringify(arr)); renderProducts();
}

async function bulkUpdateStatus(status){
  const ids=Array.from(document.querySelectorAll('.rowChk:checked')).map(ch=>Number(ch.value));
  if(!ids.length) return showToast('H√£y ch·ªçn s·∫£n ph·∫©m','warning');
  for(const id of ids){ await supabase.from('products').update({status}).eq('product_id',id); const t=products.find(p=>p.product_id===id); if(t) t.status=status; }
  showToast(`ƒê√£ c·∫≠p nh·∫≠t ${ids.length} s·∫£n ph·∫©m`,'success'); applyProductFilter();
}

function editProduct(p){
  document.getElementById('pmTitle').innerText=p? 'Ch·ªânh s·ª≠a s·∫£n ph·∫©m':'Th√™m s·∫£n ph·∫©m';
  document.getElementById('editId').value=p?.product_id||'';
  document.getElementById('pname').value=p?.product_name||'';
  document.getElementById('pcate').value=p?.category_id||'';
  document.getElementById('pprice').value=p?.price||0;
  document.getElementById('pstock').value=p?.stock||0;
  document.getElementById('pdesc').value=p?.description||'';
  // pricing tab
  document.getElementById('discountPercent').value = localStorage.getItem(discountKey(p?.product_id))||'';
  const img=document.getElementById('imgPreview'); if(p?.image_url){ img.src=p.image_url; img.classList.remove('d-none'); } else { img.classList.add('d-none'); }
  // variants
  loadVariants(p?.product_id);
  new bootstrap.Modal('#productModal').show();
}

async function loadVariants(pid){
  const area=document.getElementById('variantArea');
  if(!pid){ area.innerHTML='<span class="text-muted">L∆∞u s·∫£n ph·∫©m tr∆∞·ªõc khi th√™m bi·∫øn th·ªÉ.</span>'; return; }
  if(!hasVariantsTable){ area.innerHTML='<span class="text-muted">Ch∆∞a c√≥ b·∫£ng product_variants ‚Äî tab n√†y ·ªü ch·∫ø ƒë·ªô ch·ªâ xem.</span>'; return; }
  const r=await supabase.from('product_variants').select('*').eq('product_id',pid).order('variant_id',{ascending:true});
  const list=r.data||[];
  area.innerHTML = list.length? `<ul class="list-group list-group-flush">
    ${list.map(v=>`<li class="list-group-item d-flex justify-content-between align-items-center">
      <span>${v.name||v.variant_name||'(no name)'} ‚Äî ${VND(v.price)} ‚Äî t·ªìn ${v.stock} ‚Äî ${v.sku||''}</span>
      <button class="btn btn-sm btn-outline-danger" onclick="deleteVariant(${v.variant_id})"><i class="fa fa-trash"></i></button>
    </li>`).join('')}
  </ul>` : '<span class="text-muted">Ch∆∞a c√≥ bi·∫øn th·ªÉ.</span>';
  document.getElementById('btnAddVariant').onclick=async (e)=>{
    e.preventDefault(); if(!hasVariantsTable) return showToast('Ch∆∞a c√≥ b·∫£ng product_variants','warning');
    const name=document.getElementById('vName').value.trim(); const price=Number(document.getElementById('vPrice').value||0);
    const stock=Number(document.getElementById('vStock').value||0); const sku=document.getElementById('vSku').value.trim();
    if(!name) return showToast('Nh·∫≠p t√™n bi·∫øn th·ªÉ','warning');
    const {error}=await supabase.from('product_variants').insert([{product_id:pid, name, price, stock, sku}]);
    if(error) return showToast('L·ªói th√™m bi·∫øn th·ªÉ: '+error.message,'danger');
    showToast('ƒê√£ th√™m bi·∫øn th·ªÉ','success'); document.getElementById('vName').value='';document.getElementById('vPrice').value='';document.getElementById('vStock').value='';document.getElementById('vSku').value=''; loadVariants(pid);
  };
  window.deleteVariant = async (vid)=>{ const {error}=await supabase.from('product_variants').delete().eq('variant_id',vid); if(error) return showToast('L·ªói x√≥a: '+error.message,'danger'); showToast('ƒê√£ x√≥a','success'); loadVariants(pid); };
}

async function duplicateProduct(id){
  const src=products.find(p=>p.product_id===id); if(!src) return;
  const clone={...src}; delete clone.product_id;
  clone.product_name=src.product_name+' (b·∫£n sao)'; clone.created_at=new Date().toISOString();
  const {error}=await supabase.from('products').insert([clone]); if(error) return showToast('L·ªói sao ch√©p: '+error.message,'danger');
  showToast('ƒê√£ nh√¢n b·∫£n','success'); await refreshProducts();
}

async function deleteProduct(id,imageUrl){
  if(!confirm('X√≥a s·∫£n ph·∫©m n√†y?')) return;
  const {error}=await supabase.from('products').delete().eq('product_id',id);
  if(error) return showToast('L·ªói x√≥a: '+error.message,'danger');
  if(imageUrl){ try{ await removeByUrl(imageUrl); }catch(_){ } }
  showToast('ƒê√£ x√≥a','success'); await refreshProducts();
}

async function saveProduct(e){
  e.preventDefault();
  const id=document.getElementById('editId').value;
  const data={ product_name:document.getElementById('pname').value, category_id:Number(document.getElementById('pcate').value), price:Number(document.getElementById('pprice').value), stock:Number(document.getElementById('pstock').value), description:document.getElementById('pdesc').value, status:'active', store_id:store.store_id };
  if(data.price<0||data.stock<0) return showToast('Gi√°/T·ªìn kho kh√¥ng h·ª£p l·ªá','warning');
  const file=document.getElementById('pimg').files[0];
  try{
    if(file){
      if(id){ const old=products.find(p=>String(p.product_id)===String(id)); if(old?.image_url){ try{await removeByUrl(old.image_url);}catch(_){ } } }
      data.image_url=await upload('product-images',file,'product_');
    }
    if(id){ await supabase.from('products').update(data).eq('product_id',id); }
    else  { await supabase.from('products').insert([data]); }
    showToast('L∆∞u s·∫£n ph·∫©m th√†nh c√¥ng','success');
    bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
    await refreshProducts();
  }catch(err){ showToast('L·ªói l∆∞u: '+err.message,'danger'); }
}

function applyDiscount(e){ if(e) e.preventDefault(); const id=document.getElementById('editId').value; if(!id) return showToast('L∆∞u s·∫£n ph·∫©m tr∆∞·ªõc','warning'); const p=Number(document.getElementById('discountPercent').value||0); if(p<0||p>90) return showToast('Ph·∫ßn trƒÉm 0-90','warning'); localStorage.setItem(discountKey(id), String(p)); showToast('ƒê√£ √°p d·ª•ng gi·∫£m t·∫°m th·ªùi','success'); renderProducts(); }
function clearDiscount(e){ if(e) e.preventDefault(); const id=document.getElementById('editId').value; if(!id) return; localStorage.removeItem(discountKey(id)); document.getElementById('discountPercent').value=''; showToast('ƒê√£ x√≥a gi·∫£m t·∫°m th·ªùi','success'); renderProducts(); }

// ===== Orders =====
async function refreshOrders(){
  const r=await supabase.from('orders').select('*').eq('store_id',store.store_id).order('created_at',{ascending:false}).limit(400);
  orders=r.data||[];
  document.getElementById('count-orders').innerText=orders.length;
  const delivered=orders.filter(o=>o.order_status==='delivered').length;
  document.getElementById('deliver-rate').innerText=orders.length? Math.round(delivered*100/orders.length)+'%':'0%';
  await hydrateBuyerNames(orders.map(o=>o.buyer_id).filter(Boolean));
  renderOrders(orders);
  const revenue=orders.filter(o=>['confirmed','delivered'].includes(o.order_status)).reduce((s,o)=>s+Number(o.total_price||0),0);
  document.getElementById('total-revenue').innerText=VND(revenue);
  drawStatusChart();
}

async function hydrateBuyerNames(ids){ const uniq=Array.from(new Set(ids)); const missing=uniq.filter(id=>!buyerMap.has(id)); if(!missing.length) return; try{ const q=await supabase.from('users').select('user_id, username, avatar_url').in('user_id',missing); if(!q.error && q.data){ q.data.forEach(u=> buyerMap.set(u.user_id,{username:u.username,avatar_url:u.avatar_url||''})); } }catch{} }

const SLA_HOURS=24;
function isOverdue(o){ const created=new Date(o.created_at); return (Date.now()-created.getTime()) > SLA_HOURS*3600*1000 && !['delivered','cancelled'].includes(o.order_status); }

function renderOrders(list){
  const tb=document.getElementById('orderTable');
  if(!list.length){ tb.innerHTML=`<tr><td colspan="6" class="text-center py-4 text-muted">Kh√¥ng c√≥ ƒë∆°n</td></tr>`; return; }
  tb.innerHTML = list.map(o=>{
    const buyer=buyerMap.get(o.buyer_id);
    const name = buyer? `<img class="avatar" src="${buyer.avatar_url||'https://via.placeholder.com/28?text=U'}" onerror="this.src='https://via.placeholder.com/28?text=U'"> ${buyer.username}` : `Kh√°ch #${o.buyer_id||'-'}`;
    const stBadge=o.order_status==='delivered'?'bg-success':o.order_status==='pending'?'bg-warning text-dark':o.order_status==='cancelled'?'bg-danger':'bg-secondary';
    const overdue = isOverdue(o) ? `<span class="badge badge-overdue ms-1">C·∫ßn x·ª≠ l√Ω</span>` : '';
    return `<tr>
      <td class="fw-semibold"><span class="linkify" onclick="openOrder(${o.order_id})">#${o.order_id}</span> ${overdue}</td>
      <td>${name}</td>
      <td class="text-end">${VND(o.total_price)}</td>
      <td><span class="badge ${stBadge}">${o.order_status}</span></td>
      <td>${new Date(o.created_at).toLocaleDateString('vi-VN')}</td>
      <td><button class="btn btn-sm btn-outline-primary" onclick="openOrder(${o.order_id})"><i class="fa fa-eye"></i></button></td>
    </tr>`;
  }).join('');
}

function filterOverdue(){ const out=orders.filter(isOverdue); renderOrders(out); showToast(`C√≥ ${out.length} ƒë∆°n qu√° h·∫°n SLA`,'warning'); }

function applyOrderFilter(){
  const id=document.getElementById('oid').value.trim();
  const st=document.getElementById('ostatus').value;
  const df=document.getElementById('dateFrom').value;
  const dt=document.getElementById('dateTo').value;
  const amin=document.getElementById('amin').value;
  const amax=document.getElementById('amax').value;
  const from=df?new Date(df):null; const to=dt?new Date(dt):null;
  const out=orders.filter(o=>{
    const byId=!id||String(o.order_id).includes(id);
    const bySt=!st||o.order_status===st;
    const d=new Date(o.created_at);
    const byDate=(!from||d>=from)&&(!to||d<=new Date(to.getFullYear(),to.getMonth(),to.getDate(),23,59,59));
    const amount=Number(o.total_price||0);
    const byAmt=(!amin||amount>=Number(amin))&&(!amax||amount<=Number(amax));
    return byId&&bySt&&byDate&&byAmt;
  });
  renderOrders(out);
}

// ===== Order Detail + RMA + Note + Label =====
async function openOrder(orderId){
  const modal=new bootstrap.Modal('#orderModal'); modal.show();
  document.getElementById('omId').innerText='#'+orderId;
  document.getElementById('orderDetail').innerHTML='<div class="text-center py-4"><div class="loading-spinner"></div></div>';
  const r=await supabase.from('orders').select('*').eq('order_id',orderId).maybeSingle();
  if(!r.data){ document.getElementById('orderDetail').innerHTML='<div class="text-danger">Kh√¥ng t·∫£i ƒë∆∞·ª£c ƒë∆°n</div>'; return; }
  currentOrder=r.data;
  // seller note hydrate
  const savedLocal=localStorage.getItem(noteKey(orderId));
  document.getElementById('sellerNote').value = (hasSellerNoteColumn && currentOrder.seller_note!=null) ? currentOrder.seller_note : (savedLocal || '');
  document.getElementById('oStatus').value=currentOrder.order_status||'pending';
  document.getElementById('cancelReason').classList.toggle('d-none', currentOrder.order_status!=='cancelled');
  if(currentOrder.cancel_reason) document.getElementById('cancelReason').value=currentOrder.cancel_reason;
  // items if any
  let itemsHtml='<em>Ch∆∞a c·∫•u h√¨nh b·∫£ng chi ti·∫øt ƒë∆°n h√†ng.</em>';
  try{ const ro=await supabase.from('order_items').select('product_name, quantity, price').eq('order_id',orderId);
    if(!ro.error && ro.data && ro.data.length){
      itemsHtml = `<table class="table table-sm"><thead><tr><th>S·∫£n ph·∫©m</th><th class="text-end">SL</th><th class="text-end">Gi√°</th></tr></thead><tbody>
        ${ro.data.map(i=>`<tr><td>${i.product_name}</td><td class="text-end">${i.quantity}</td><td class="text-end">${VND(i.price)}</td></tr>`).join('')}
      </tbody></table>`;
    }
  }catch{}
  document.getElementById('orderDetail').innerHTML = `
    <div class="d-flex justify-content-between flex-wrap">
      <div>
        <div><strong>M√£ ƒë∆°n:</strong> #${currentOrder.order_id} ${isOverdue(currentOrder)?'<span class="badge badge-overdue ms-1">C·∫ßn x·ª≠ l√Ω</span>':''}</div>
        <div><strong>Ng√†y:</strong> ${new Date(currentOrder.created_at).toLocaleString('vi-VN')}</div>
        <div><strong>Kh√°ch:</strong> ${currentOrder.buyer_id||'-'}</div>
      </div>
      <div class="text-end">
        <div><strong>T·ªïng ti·ªÅn:</strong> ${VND(currentOrder.total_price)}</div>
        ${currentOrder.cancel_reason?`<div class="text-danger"><strong>L√Ω do h·ªßy:</strong> ${currentOrder.cancel_reason}</div>`:''}
      </div>
    </div>
    <hr>${itemsHtml}`;

  // actions
  document.getElementById('btnSaveOrder').onclick=updateOrderStatus;
  document.getElementById('btnCreateReturn').onclick=createReturnRequest;
  document.getElementById('btnPrintLabel').onclick=printLabel;
}

async function updateOrderStatus(){
  if(!currentOrder) return;
  const st=document.getElementById('oStatus').value;
  const reason=document.getElementById('cancelReason').value||null;
  const note=document.getElementById('sellerNote').value||null;
  const payload={ order_status:st, cancel_reason: st==='cancelled'?reason:null };
  if(hasSellerNoteColumn) payload.seller_note = note;
  const {error}=await supabase.from('orders').update(payload).eq('order_id', currentOrder.order_id);
  if(error){ showToast('L·ªói c·∫≠p nh·∫≠t: '+error.message,'danger'); return; }
  if(!hasSellerNoteColumn){ localStorage.setItem(noteKey(currentOrder.order_id), note||''); }
  showToast('ƒê√£ c·∫≠p nh·∫≠t ƒë∆°n','success'); bootstrap.Modal.getInstance(document.getElementById('orderModal')).hide(); await refreshOrders();
}

async function createReturnRequest(){
  if(!currentOrder) return;
  if(!hasReturnsTable){ showToast('Ch∆∞a c√≥ b·∫£ng returns ‚Äî kh√¥ng th·ªÉ t·∫°o RMA','warning'); return; }
  const reason=prompt('L√Ω do ho√†n/ƒë·ªïi?'); if(!reason) return;
  const {error}=await supabase.from('returns').insert([{ order_id: currentOrder.order_id, reason, status:'requested', created_at:new Date().toISOString() }]);
  if(error) return showToast('L·ªói t·∫°o RMA: '+error.message,'danger');
  showToast('ƒê√£ t·∫°o y√™u c·∫ßu ho√†n','success');
}

function printLabel(){
  const el=document.getElementById('labelArea'); el.classList.remove('d-none');
  el.innerHTML = `
    <div><strong>E-Shop</strong></div>
    <div>M√£ ƒë∆°n: #${currentOrder.order_id}</div>
    <div>Ng√†y: ${new Date(currentOrder.created_at).toLocaleString('vi-VN')}</div>
    <div>T·ªïng: ${VND(currentOrder.total_price)}</div>
    <div style="margin-top:6px;border-top:1px dashed #999;padding-top:6px">SCN: ${currentOrder.order_id}-${Date.now().toString().slice(-6)}</div>
  `;
  window.print();
  setTimeout(()=>el.classList.add('d-none'), 500);
}

// ===== Charts =====
function drawRevenueChart(months){
  const ctx=document.getElementById('revenueChart'); const map=new Map();
  const ok=orders.filter(o=>['confirmed','delivered'].includes(o.order_status));
  ok.forEach(o=>{ const d=new Date(o.created_at); const key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; map.set(key,(map.get(key)||0)+Number(o.total_price||0)); });
  const now=new Date(); const data=[];
  for(let i=months-1;i>=0;i--){ const d=new Date(now.getFullYear(),now.getMonth()-i,1); const key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; data.push({label:key,value:map.get(key)||0}); }
  if(window._chart) window._chart.destroy();
  window._chart = new Chart(ctx, { type:'bar',
    data:{ labels:data.map(x=>x.label), datasets:[{ label:'Doanh thu (‚Ç´)', data:data.map(x=>x.value) }] },
    options:{ responsive:true, plugins:{ legend:{display:false}, tooltip:{callbacks:{label:c=>VND(c.raw)}} },
      scales:{ y:{ ticks:{ callback:v=>Number(v).toLocaleString('vi-VN') } } } }
  });
}
function drawStatusChart(){
  const ctx=document.getElementById('statusChart');
  const groups={pending:0,confirmed:0,shipping:0,delivered:0,cancelled:0};
  orders.forEach(o=>{ groups[o.order_status]=(groups[o.order_status]||0)+1; });
  if(window._statusChart) window._statusChart.destroy();
  window._statusChart = new Chart(ctx, { type:'doughnut',
    data:{ labels:Object.keys(groups), datasets:[{ data:Object.values(groups) }] },
    options:{ responsive:true, plugins:{ legend:{position:'bottom'} } } });
}

// ===== Top Buyers & Capital =====
function buildTopBuyers(){
  const box=document.getElementById('top-buyers');
  if(!orders.length){ box.innerHTML='<div class="text-muted">Ch∆∞a c√≥ ƒë∆°n.</div>'; return; }
  const map=new Map();
  orders.forEach(o=> map.set(o.buyer_id, (map.get(o.buyer_id)||0)+Number(o.total_price||0)));
  const top=[...map.entries()].sort((a,b)=>b[1]-a[1]).slice(0,5);
  box.innerHTML = `<ol class="mb-0">${top.map(([bid,amt])=>`<li class="mb-1 d-flex justify-content-between"><span>${(buyerMap.get(bid)?.username)||('Kh√°ch #'+bid)}</span><span class="text-muted">${VND(amt)}</span></li>`).join('')}</ol>`;
}

function buildCapitalTable(){
  const tb=document.getElementById('capitalTable'); if(!products.length){ tb.innerHTML='<tr><td colspan="4" class="text-center text-muted py-3">Ch∆∞a c√≥ s·∫£n ph·∫©m</td></tr>'; return; }
  const rows=products.map(p=>({ name:p.product_name, price:Number(p.price||0), stock:Number(p.stock||0), value:Number(p.price||0)*Number(p.stock||0) }))
                    .sort((a,b)=>b.value-a.value).slice(0,10);
  tb.innerHTML = rows.map(r=>`<tr><td>${r.name}</td><td class="text-end">${VND(r.price)}</td><td class="text-end">${r.stock}</td><td class="text-end">${VND(r.value)}</td></tr>`).join('');
}

// ===== Saved Filters =====
function hydrateSavedFilters(){ const sel=document.getElementById('savedFilters'); const arr=JSON.parse(localStorage.getItem(savedFiltersKey)||'[]'); sel.innerHTML='<option value="">B·ªô l·ªçc ƒë√£ l∆∞u</option>'+arr.map((f,i)=>`<option value="${i}">${f.name}</option>`).join(''); }
function saveCurrentFilter(){ const name=prompt('T√™n b·ªô l·ªçc?'); if(!name) return; const obj={name, kw:kw.value, cate:fcate.value, st:fstatus.value, pmin:pmin.value, pmax:pmax.value, smax:stockMax.value}; const arr=JSON.parse(localStorage.getItem(savedFiltersKey)||'[]'); arr.push(obj); localStorage.setItem(savedFiltersKey, JSON.stringify(arr)); hydrateSavedFilters(); showToast('ƒê√£ l∆∞u b·ªô l·ªçc','success'); }
function loadSavedFilter(){ const idx=this.value; if(idx==='') return; const arr=JSON.parse(localStorage.getItem(savedFiltersKey)||'[]'); const f=arr[idx]; if(!f) return; kw.value=f.kw||''; fcate.value=f.cate||''; fstatus.value=f.st||''; pmin.value=f.pmin||''; pmax.value=f.pmax||''; stockMax.value=f.smax||''; applyProductFilter(); }

function hydrateSavedOrderFilters(){ const sel=document.getElementById('savedOrderFilters'); const arr=JSON.parse(localStorage.getItem(savedOrderFiltersKey)||'[]'); sel.innerHTML='<option value="">B·ªô l·ªçc ƒë∆°n ƒë√£ l∆∞u</option>'+arr.map((f,i)=>`<option value="${i}">${f.name}</option>`).join(''); }
function saveCurrentOrderFilter(){ const name=prompt('T√™n b·ªô l·ªçc ƒë∆°n?'); if(!name) return; const obj={name, id:oid.value, st:ostatus.value, df:dateFrom.value, dt:dateTo.value, amin:amin.value, amax:amax.value}; const arr=JSON.parse(localStorage.getItem(savedOrderFiltersKey)||'[]'); arr.push(obj); localStorage.setItem(savedOrderFiltersKey, JSON.stringify(arr)); hydrateSavedOrderFilters(); showToast('ƒê√£ l∆∞u b·ªô l·ªçc ƒë∆°n','success'); }
function loadSavedOrderFilter(){ const idx=this.value; if(idx==='') return; const arr=JSON.parse(localStorage.getItem(savedOrderFiltersKey)||'[]'); const f=arr[idx]; if(!f) return; oid.value=f.id||''; ostatus.value=f.st||''; dateFrom.value=f.df||''; dateTo.value=f.dt||''; amin.value=f.amin||''; amax.value=f.amax||''; applyOrderFilter(); }

// ===== Import CSV =====
function handleImportFile(e){
  const file=e.target.files?.[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=(ev)=>{
    const text=ev.target.result; const lines=text.split(/\r?\n/).filter(x=>x.trim().length);
    // Expect header: product_name,category_id,price,stock,description,image_url
    const header=lines[0].split(',').map(s=>s.trim().toLowerCase());
    const required=['product_name','category_id','price','stock','description','image_url'];
    const ok = required.every(k=>header.includes(k));
    if(!ok){ showToast('CSV sai header. C·∫ßn: '+required.join(', '),'danger'); return; }
    importRows = lines.slice(1).map((line, idx)=>{
      const cols=line.split(','); const row={}; header.forEach((h,i)=> row[h]=cols[i]||''); row._line=idx+2; return row;
    }).filter(r=>r.product_name);
    const tb=document.getElementById('importPreview');
    tb.innerHTML = importRows.slice(0,50).map((r,i)=>`<tr><td>${i+1}</td><td>${r.product_name}</td><td>${r.category_id}</td><td>${r.price}</td><td>${r.stock}</td><td>${r.image_url}</td><td>${r.description}</td></tr>`).join('');
    new bootstrap.Modal('#importModal').show();
  };
  reader.readAsText(file);
}

async function confirmImport(){
  if(!importRows.length) return;
  // Basic validate
  const bad = importRows.find(r=> isNaN(Number(r.category_id)) || isNaN(Number(r.price)) || isNaN(Number(r.stock)));
  if(bad){ showToast('C√≥ d√≤ng sai d·ªØ li·ªáu s·ªë ·ªü line '+bad._line,'danger'); return; }
  const payload = importRows.map(r=>({ product_name:r.product_name, category_id:Number(r.category_id), price:Number(r.price), stock:Number(r.stock), description:r.description, image_url:r.image_url, status:'active', store_id:store.store_id }));
  const {error}=await supabase.from('products').insert(payload);
  if(error) return showToast('L·ªói import: '+error.message,'danger');
  showToast('ƒê√£ import s·∫£n ph·∫©m','success'); bootstrap.Modal.getInstance(document.getElementById('importModal')).hide(); await refreshProducts();
}

// ===== Export CSV =====
function downloadCSV(filename, rows){ const q=v=>`"${String(v??'').replace(/"/g,'""')}"`; const csv=rows.map(r=>r.map(q).join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); }
function exportOrdersCSV(){ const rows=[['Order','Buyer','TotalPrice','Status','CreatedAt']].concat(orders.map(o=>['#'+o.order_id,(buyerMap.get(o.buyer_id)?.username)||('Kh√°ch #'+(o.buyer_id||'-')),o.total_price,o.order_status,o.created_at])); downloadCSV(`orders_${new Date().toISOString().slice(0,7)}.csv`, rows); }

// ===== Logout =====
function logout(){ localStorage.removeItem('currentUser'); location.href='login.html'; }
</script>
</body>
</html>
